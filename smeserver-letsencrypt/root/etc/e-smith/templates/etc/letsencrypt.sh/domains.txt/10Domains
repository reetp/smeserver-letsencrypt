{
    use strict;
    use warnings;
    use esmith::ConfigDB;

    my $configDB  = esmith::ConfigDB->open_ro            or die("can't open Config DB");
    my $domainsDB = esmith::ConfigDB->open_ro('domains') or die("can't connect to domains database");
    my $hostsDB   = esmith::ConfigDB->open_ro('hosts')   or die("can't connect to hosts database");

    # my $dbKey     = 'domain';

    #    my $systemMode = $configDB->get("SystemMode")->value;

    #    if ( $systemMode ne 'servergateway' ) {
    #        $OUT .= "# System not in Server Gateway mode\n";
    #    }

    my $letsencryptStatus = $configDB->get_prop( 'letsencrypt', 'status' ) || 'disabled';

    if ( $letsencryptStatus ne 'disabled' ) {

        # This should get all the connections in an array

        my @domains = $domainsDB->keys;

        # print "@domains\n";

        # First get all the domains

        foreach my $domain (@domains) {

            my $domainEnabled = $domainsDB->get_prop( "$domain", 'letsencryptSSLcert' ) || 'disabled';

            if ( $domainEnabled eq 'enabled' ) {

                #code

                $OUT .= "$domain ";
            }

            # Now check for hosts

            my @hosts = $hostsDB->keys;

            foreach my $fqdn (@hosts) {

                # Lets get the hostname
                my $hostname = $fqdn;
                $hostname =~ s/\..*//;

                # print "$hostname\n";

                # Lets get the domain name
                my $domainname = $fqdn;
                $domainname =~ s/.*?\.//;

                # print "$domainname\n";

                # is the domain name from the hosts file the same as that in the domains file ?
                my $hostEnabled = $hostsDB->get_prop( "$fqdn", 'letsencryptSSLcert' ) || 'disabled';

                if ( $domainname eq $domain && $hostEnabled eq 'enabled' ) {

                    # Are we self ?
                    my $type = $hostsDB->get_prop( "$fqdn", 'HostType' );

                    if ( $type eq 'Self' ) {

                        #   print "$fqdn  $type\n";
                        $OUT .= "$fqdn ";

                    }
                }
            }
        }
    }

    else {
        $OUT .= "# letsencrypt is disabled\n";
    }
}
